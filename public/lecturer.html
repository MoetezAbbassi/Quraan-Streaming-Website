<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lecturer Panel â€” Quraan Streaming</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.min.js"></script>
</head>
<body>
  <header><h1>Lecturer Dashboard</h1></header>
  <div class="container">
    <div id="login-panel">
      <input type="password" id="pwd" placeholder="Lecturer Password" />
      <button id="btnLogin" type="button" class="btn">Login</button>
    </div>
    <div id="stream-panel" class="hidden">
      <h2>Screen Preview + Controls</h2>
      <video id="preview" autoplay muted></video>
      <div class="controls">
        <button id="btnShare" type="button" class="btn">ðŸ”— Share Screen</button>
        <button id="btnMute" type="button" class="btn">Mute Mic</button>
        <button id="btnEnd" type="button" class="btn">End Lecture</button>
      </div>
    </div>
  </div>

  <script>
    (async function init() {
      console.log("[init] Starting lecturer UI...");

      if (!window.livekitClient || !window.livekitClient.connect) {
        console.error("[init] livekit-client failed to load!");
        alert("Error: livekit-client did not load. Check your network and script tag.");
        return;
      }
      const { connect } = window.livekitClient;
      console.log("[init] livekit-client loaded successfully.");

      const loginPanel = document.getElementById("login-panel");
      const streamPanel = document.getElementById("stream-panel");
      const preview = document.getElementById("preview");
      const btnLogin = document.getElementById("btnLogin");
      const btnShare = document.getElementById("btnShare");
      const btnMute = document.getElementById("btnMute");
      const btnEnd = document.getElementById("btnEnd");

      let room, micEnabled = true;

      btnLogin.onclick = async () => {
        console.log("[Login] Button clicked");
        const pwd = document.getElementById("pwd").value;
        console.log("[Login] Password entered:", pwd);
        try {
          const resp = await fetch("/lecturer/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pwd })
          });
          console.log("[Login] Response:", resp.status);
          if (!resp.ok) throw new Error("Auth failed");
          const data = await resp.json();
          console.log("[Login] Received token/url.");
          room = await connect(data.url, data.token, { audio: true });
          console.log("[LiveKit] Connected as lecturer.");
          loginPanel.classList.add("hidden");
          streamPanel.classList.remove("hidden");
        } catch (e) {
          console.error("[Login] Error:", e);
          alert("Login failed: " + e.message);
        }
      };

      btnShare.onclick = async () => {
        if (!room) return alert("Not connected");
        try {
          console.log("[Share] Attempting screen share...");
          const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          const [pubTrack] = room.localParticipant.publishStream(stream);
          preview.srcObject = new MediaStream([pubTrack.mediaStreamTrack]);
          console.log("[Share] Screen shared successfully.");
        } catch (e) {
          console.error("[Share] Error:", e);
        }
      };

      btnMute.onclick = () => {
        if (!room) return;
        micEnabled = !micEnabled;
        room.localParticipant.audioTracks.forEach(t => t.track.setMuted(!micEnabled));
        btnMute.textContent = micEnabled ? "Mute Mic" : "Unmute Mic";
        console.log("[Mute] Mic:", micEnabled ? "ON" : "OFF");
      };

      btnEnd.onclick = () => {
        if (room) room.disconnect();
        console.log("[End] Lecture ended; reloading...");
        location.reload();
      };
    })();
  </script>
</body>
</html>
