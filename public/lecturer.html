<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lecturer Panel â€” Quraan Stream</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Load the UMD bundle correctly -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/livekit-client/2.14.0/livekit-client.umd.min.js"></script>
</head>
<body>
  <header><h1>Lecturer Dashboard</h1></header>
  <div class="container">
    <div id="login-panel">
      <input type="password" id="pwd" placeholder="Lecturer Password" />
      <button id="btnLogin" type="button" class="btn">Login</button>
    </div>
    <div id="stream-panel" class="hidden">
      <h2>Screen Preview + Controls</h2>
      <video id="preview" autoplay muted></video>
      <div class="controls">
        <button id="btnShare" type="button" class="btn">ðŸ”— Share Screen</button>
        <button id="btnMute" type="button" class="btn">Mute Mic</button>
        <button id="btnEnd" type="button" class="btn">End Lecture</button>
      </div>
    </div>
  </div>

  <script>
    (async function init() {
      console.log("[init] Starting lecturer UI...");

      // Check for UMD global
      if (!window.LivekitClient || !window.LivekitClient.connect) {
        console.error("[init] LivekitClient not found!");
        alert("Error: LivekitClient failed to load. Check the script URL.");
        return;
      }
      const { connect } = window.LivekitClient;
      console.log("[init] LivekitClient loaded!");

      const loginPanel = document.getElementById("login-panel");
      const streamPanel = document.getElementById("stream-panel");
      const preview = document.getElementById("preview");
      const btnLogin = document.getElementById("btnLogin");
      const btnShare = document.getElementById("btnShare");
      const btnMute = document.getElementById("btnMute");
      const btnEnd = document.getElementById("btnEnd");

      let room;
      let micEnabled = true;

      btnLogin.onclick = async () => {
        console.log("[Login] Clicked");
        const pwd = document.getElementById("pwd").value;
        console.log("[Login] Pwd:", pwd);

        try {
          const resp = await fetch("/lecturer/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pwd })
          });
          console.log("[Login] HTTP status:", resp.status);
          if (!resp.ok) throw new Error("Bad login");
          const { token, url } = await resp.json();
          console.log("[Login] Got token/url");

          room = await connect(url, token, { audio: true });
          console.log("[LiveKit] Connected");

          loginPanel.classList.add("hidden");
          streamPanel.classList.remove("hidden");
        } catch (err) {
          console.error("[Login] Error:", err);
          alert("Login failed: " + err.message);
        }
      };

      btnShare.onclick = async () => {
        if (!room) return alert("Not connected");
        try {
          console.log("[Share] Requesting screen share...");
          const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          const [publication] = room.localParticipant.publishStream(stream);
          preview.srcObject = new MediaStream([publication.mediaStreamTrack]);
          console.log("[Share] Screen shared");
        } catch (err) {
          console.error("[Share] Error:", err);
        }
      };

      btnMute.onclick = () => {
        if (!room) return;
        micEnabled = !micEnabled;
        room.localParticipant.audioTracks.forEach(pub =>
          pub.track.setMuted(!micEnabled)
        );
        btnMute.textContent = micEnabled ? "Mute Mic" : "Unmute Mic";
        console.log("[Mute] Mic enabled:", micEnabled);
      };

      btnEnd.onclick = () => {
        if (room) room.disconnect();
        console.log("[End] Lecture ended");
        location.reload();
      };
    })();
  </script>
</body>
</html>
